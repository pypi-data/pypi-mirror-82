---
- name: setup DNS client
  hosts: bind-client-group:!external-host
  become: true
  vars:
    dns_a_record: "{{ ansible_hostname }}"
    dns_cname_record: '{{ ansible_hostname | replace("-host","") }}'
    dns_a: "{{ ansible_host }}"

  pre_tasks:

    - name: set A
      nsupdate:
        server: "{{ hostvars[item]['ansible_host'] }}"
        zone: "{{ domain }}"
        record: "{{ dns_a_record }}"
        ttl: 1800
        type: A
        value: "{{ dns_a }}"
        state: "{{ 'absent' if dns_a_record in groups['deleted-hosts'] else 'present' }}"
      delegate_to: "{{ item }}"
      loop: "{{groups['bind-service-group']}}"

    - name: set CNAME
      nsupdate:
        server: "{{ hostvars[item]['ansible_host'] }}"
        zone: "{{ domain }}"
        record: "{{ dns_cname_record }}"
        ttl: 1800
        type: CNAME
        value: "{{ dns_a_record }}"
      delegate_to: "{{ item }}"
      loop: "{{groups['bind-service-group']}}"
      when: dns_a_record not in groups['deleted-hosts']
