var teramap=function(e){var t={};function i(a){if(t[a])return t[a].exports;var n=t[a]={i:a,l:!1,exports:{}};return e[a].call(n.exports,n,n.exports,i),n.l=!0,n.exports}return i.m=e,i.c=t,i.d=function(e,t,a){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(i.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)i.d(a,n,function(t){return e[t]}.bind(null,n));return a},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=6)}([function(e,t){e.exports=L},function(e,t,i){"use strict";i.d(t,"a",(function(){return s})),i.d(t,"b",(function(){return r}));var a=i(0),n=i.n(a),s=(i(3),n.a.NumberIcon=n.a.DivIcon.extend({options:{html:"",shadowUrl:null,iconSize:new n.a.Point(20,20),className:"leaflet-number-marker"}}),n.a.numberIcon=function(e){var t="object"==typeof e?e:{html:e};return new n.a.NumberIcon(t)}),r=n.a.numberMarker=function(e,t){return n.a.marker(e,{icon:n.a.numberIcon(t)})}},,function(e,t,i){},,,function(e,t,i){"use strict";i.r(t),i.d(t,"fieldwork",(function(){return k}));var a=i(1);function n(e){return"is_primary"in e&&e.is_primary}function s(e){var t=[],i=e.species;for(var a in i)(n(i[a])||i[a].is_active)&&t.push(i[a]);return function(e){e.sort((function(e,t){return n(e)&&!n(t)?-1:n(t)&&!n(e)?1:e.name<t.name?-1:1}))}(t),t.map((function(e){return e.pk}))}class r{constructor(e){var t=["subjects","groups"];if(t.forEach((function(t){if(0===Object.keys(e[t]).length)throw new Error("No "+t+" provided")})),0===Object.keys(e.species).length&&!e.species_url)throw new Error("Either species or species_url (or both) should be defined");var i=t.concat(["species","pinpoint_target","species_url"]),a=this;if(i.forEach((function(t){e[t]&&(a[t]=e[t])})),this.pinpoint_observation="observation"==e.pinpoint_target,this.sample_attrs=e.sample_attrs||{},this.active_species=s(e),this.eachGroup((function(e){e.species=[]})),this.species)for(var n in this.species){var r=this.species[n];this.groups[r.group].species.push(+n)}}activateSpecies(e,t){this.species[e]||(this.species[e]=t,this.groups[t.group].species.push(e)),this.species[e].is_active=!0,-1===this.active_species.indexOf(e)&&this.active_species.push(e)}eachSubject(e,t){(void 0!==t?this.groups[t].subjects:Object.keys(this.subjects)).forEach((function(t){e(this.subjects[t],t)}),this)}eachSubjectName(e){var t={};for(var i in this.eachSubject((function(e,i){e in t||(t[e]=[]),t[e].push(+i)})),t)e(i,t[i])}_eachSpecies(e,t,i){for(var a in this.species)t&&!t(this.species[a])||e.call(i,this.species[a],this.species[a].pk)}sortActiveSpecies(){this.active_species=s(this)}eachActiveSpecies(e,t){var i=this.active_species;if(void 0!==t){var a=this.groups[t].species;i=i.filter((function(e){return-1!==a.indexOf(e)}))}(i=i.map((function(e){return this.species[e]}),this)).forEach((function(t){e(t,t.pk)}),this)}eachSelectableSpecies(e,t){var i=!1;void 0!==t&&(i=this.groups[t].species),this._eachSpecies(e,(function(e){return(!i||-1!==i.indexOf(e.pk))&&!(n(e)||e.is_active)}))}eachGroup(e){for(var t in this.groups)e(this.groups[t],t)}getGroupForSpecies(e){for(var t in this.groups){var i=this.groups[t];if(-1!==i.species.indexOf(e.pk))return i}}selectSubjectForSpecies(e,t){var i;return this.getGroupForSpecies(t).subjects.forEach((function(t){-1!==e.indexOf(t)&&(i=t)})),i}hasSampleAttrs(){return!this.pinpoint_observation&&Object.keys(this.sample_attrs).length>0}eachSampleAttr(e){for(var t in this.sample_attrs)e(this.sample_attrs[t],t)}}var o=function(e){var t=this.protocol=new r(e.protocol),i=t.pinpoint_observation;this.samples=e.initial_data||[],i&&0===this.samples.length&&this.samples.push({observations:[]});try{this.samples.forEach((function(e){e.observations.forEach((function(e){e.species&&t.activateSpecies(e.species)}))}))}catch(e){throw new Error("Could not activate species for initial data. Make sure all species refered to in initial_data are present in protocol.species.")}function s(e){return[(e=L.latLng(e)).lat,e.lng]}this.updateAttribute=function(e,t,i){this.getSample(e).attributes[t]=i},this.getSample=function(e){return i?this.samples[0]:(this.samples.forEach((function(i){i.name==e&&(t=i)})),t);var t},this.getObservation=function(e,t,a){var n,s=this.getSample(e);return s.observations.forEach((function(r){if(i)r.name===e&&(n=r);else{var o=r.species==t&&r.subject==a;s.name==e&&o&&(n=r)}})),n},this.removeObservation=function(e,t,a){var n=this.getSample(e),s=this.getObservation(e,t,a),r=n.observations.indexOf(s);i?s.count=void 0:n.observations.splice(r,1)},this.updateCount=function(e,a,s,r){void 0!==r&&""!==r&&(r=Math.abs(+r));var o=t.species[a],c=this.getSample(e),p=this.getObservation(e,a,s);p&&L.extend(p,{species:a,subject:s,count:r}),!n(o)&&void 0===r||""===r?p&&this.removeObservation(e,a,s):p||i||c.observations.push({species:a,subject:s,count:r})},this.observedCount=function(e,t,i){var a=this.getObservation(e,t,i);return a?a.count:void 0},this.next_pin_name=function(){var e=0;return this.samples.forEach((function(t){i?t.observations.forEach((function(t){e=Math.max(e,+t.name)})):e=Math.max(e,+t.name)})),""+(e+1)},this.createPin=function(e){var t={name:this.next_pin_name(),delete_on_cancel:!0};i?this.getSample().observations.push(t):(L.extend(t,{observations:[],attributes:{}}),this.samples.push(t));return e&&(t.latlng=s(e)),t},this.createMarker=function(e){var t=Object(a.b)(e.latlng,e.name);return t.feature={properties:e},t},this.setLatLng=function(e,t){this.getPin(e).latlng=s(t)},this.getPin=function(e){return i?this.getObservation(e):this.getSample(e)},this.eachPin=function(e){var t=i?this.samples[0].observations:this.samples;for(var a in t)e(t[a],a)},this.hasObservations=function(e){var t=this.getPin(e);return void 0!==t&&(i?"species"in t:t.observations.length>0)},this.removePin=function(e){var t;i?t=this.getSample().observations:t=this.samples;for(var a in t)t[a].name==e&&t.splice(a,1)},this.tableData=function(){var e=[],a=[o("location"),o("species")];i?a.push(o("subject"),o("count")):t.eachSubjectName((function(e){a.push(e)})),e.push(a);var n=this;return this.samples.forEach((function(a){if(i)a.observations.forEach((function(i){var a=t.species[i.species],n=t.subjects[i.subject];e.push([i.name,a,n,i.count])}));else{if(a.observations.length<1){var s=[a.name,{name:o("no observations")}];return t.eachSubjectName((function(){s.push("")})),void e.push(s)}t.eachActiveSpecies((function(i){var s=[];t.eachSubjectName((function(e,r){var o=t.selectSubjectForSpecies(r,i);s.push(n.observedCount(a.name,i.pk,o))})),s.some((function(e){return void 0!==e}))&&e.push([a.name,i].concat(s))}))}})),e},this.serialize=function(){return JSON.stringify(this.samples,null,2)},this._=function(t,i){var a=t;return"messages"in e&&(a=e.messages[t]||t),i?a.charAt(0).toUpperCase()+a.substring(1):a};var o=this._};function c(e){var t,i,a,n;for(i=1,a=arguments.length;i<a;i++)for(t in n=arguments[i])e[t]=n[t];return e}var p=/\{ *([\w_-]+) *\}/g;function u(e,t){return e.replace(p,(function(e,i){var a=t[i];if(void 0===a)throw new Error("No value provided for variable "+e);return"function"==typeof a&&(a=a(t)),a}))}function l(e,t){var i=t||"";return n(e)&&(i+=" app-transect-species-primary"),u('<span class="{class}" title="{scientific_name}">{name}</span>',{class:i,scientific_name:e.scientific_name||"",name:e.name||"<em>"+e.scientific_name+"</em>"})}var h=class{constructor(e,t,i){this.form_data=e,this.options=t,this.selector=i}render(e){var t,i='<div class="leaflet-number-marker">{name}</div>&nbsp;&nbsp;<span data-pin-name="{name}" class="btn-group btn-group-xs"><span data-target="edit" class="btn btn-default"><i class="fa fa-edit"></i></span>'+(this.options.mapclick_create?'<span data-target="move-marker" class="btn btn-default"><i class="fa fa-map-marker"></i></span>':"")+'<span data-target="delete" class="btn btn-danger"><i class="fa fa-trash"></i></span></span>',a="<thead><tr>";e[0].forEach((function(e){a+="<th>"+e+"</th>"})),a+="</tr>",e.slice(1).forEach((function(e){var n=e[0];a+=void 0===t||t!=n?'<tr class="first"><td>'+u(i,{name:n}):"<tr><td>",a+="</td>",a+="<td>"+l(e[1])+"</td>",e.slice(2).forEach((function(e){a+="<td>"+(e=void 0===e?"":e)+"</td>"})),t=n})),a+="</tbody>",this.selector.html(a)}};function d(e){return function(t){return{original:t,id:void 0===t.id?t.pk:t.id,text:t.name||"<em>"+t.scientific_name+"</em>",is_primary:n(t),group:t.group||e.getGroupForSpecies(t)}}}var f=class{constructor(e,t,i){this.protocol=e,this.group=void 0,this.dropdownParent=t,this.placeholder=i}data(){var e=this.protocol,t=[];function i(e){t.push(e)}return e.pinpoint_observation&&e.eachActiveSpecies(i,this.group),e.eachSelectableSpecies(i,this.group),(t=t.map(d(e))).unshift({id:"",text:this.placeholder}),t}set_group(e){return this.group=e.pk,this}render(e,t){var i={dropdownParent:this.dropdownParent,escapeMarkup:function(e){return e},templateResult:function(e){return"is_primary"in e&&n(e)?'<span class="app-transect-species-primary">'+e.text+"</span>":e.text}};if(this.protocol.species_url){var a=d(this.protocol),s=this.group;if(i.placeholder=this.placeholder,i.ajax={url:this.protocol.species_url,dataType:"json",data:function(e){return{json:!0,group:s,search:e.term,page:e.page||1}},processResults:function(e){return e.results=e.results.map(a),e}},e.select2(i),t){var r=a(t),o=new Option(r.text,r.id,!0,!0);e.append(o),e.trigger({type:"select2:change",params:{data:r}})}}else{if(i.data=this.data(),1==i.data.length)return e.hide(),!1;e.select2(i),t&&e.val(t.pk).trigger("change")}return e}};function v(e){return e.charAt(0).toUpperCase()+e.slice(1)}function m(e){return'<div class="form-group col-md-4">'+e+"</div>"}function b(e){e=c({type:"text"},e);var t=[];for(var i in e)t.push(i+'="'+e[i]+'"');return"<input "+t.join(" ")+"/>"}var _=function(e,t){var i=e._,a=e.protocol;this.modal=function(n,s){var r=e.getPin(s);n.data("name",s),n.find(".pinpoint-name").html('<div class="leaflet-number-marker">'+s+"</div>");var o=n.find(".modal-header");if(o.find("label").remove(),t.enable_fix_location_checkbox){o.prepend('<label class="pull-right"><input type="checkbox" /> '+v(i("fix location",!0))+"</label>");var c="fix_location"in r&&!0===r.fix_location;o.find("input[type=checkbox]").prop("checked",c)}var p=n.find(".modal-body"),u="";if(""==p.html().trim()){p.append("<form>"),a.hasSampleAttrs()&&(u+="<h4>"+v(i("attributes",!0))+"</h4>",a.eachSampleAttr((function(e,t){var i='<label class="control-label col-sm-4">'+e.name+"</label>";i+='<div class="col-sm-6">';var a=r.attributes[t]||"";e.choices&&e.choices.length>0?(i+='<select data-sample-attr="'+t+'" class="form-control">',e.choices.forEach((function(e){var t=e[0]==a?'selected="selected"':"";i+='<option value="'+e[0]+'" '+t+">"+e[1]+"</option>"})),i+="</select>"):i+=b({type:-1!==["number","color","date","month","password","range","time","text"].indexOf(e.type)?e.type:"text",class:"form-control","data-sample-attr":t,value:a}),u+=m(i+="</div>")})),p.append(u));var h=$(t.modal_selector).find(".modal-content"),d=new f(a,h,v(i("type the first 4 letters of the species name and select a species",!0)));if(a.pinpoint_observation){p.append(m('<select class="form-control species-selector"></select>')+m('<select class="form-control subject-selector"><option disabled="disabled">'+v(i("select species first",!0))+"</option></select> ")+m(b({class:"form-control number-input",min:0,name:"count",placeholder:v(i("count"))})));var _=e.getObservation(s),g=void 0;if(_&&_.species||!a.species_url&&1==Object.keys(a.species).length){var k=_&&_.species?_.species:Object.keys(a.species)[0];g=a.species[k]}d.render(p.find(".species-selector"),g).on("change",(function(){var e=$(this).select2("data")[0];e&&e.original&&j(e.original)}));var y=p.find(".subject-selector"),j=function(e){a.activateSpecies(e.pk,e);var i=+y.val(),n=!1,s=[];a.eachSubject((function(e,t){s.push({id:t,text:e}),t==i&&(n=!0)}),e.group),y.empty().select2({dropdownParent:$(t.modal_selector).find(".modal-content"),data:s}),i&&n&&y.val(i).trigger("change")};g&&j(g),_&&_.subject&&_.count&&_.subject&&(y.val(_.subject).trigger("change"),p.find('[name="count"]').val(_.count))}else u='<table class="table app-transect-table">',a.eachGroup((function(t){u+="<tr><th>"+t.name+"</th>",a.eachSubject((function(e){u+="<td>"+e+"</td>"}),t.pk),u+="</tr>",a.eachActiveSpecies((function(i){u+=function(t,i,n){var s="<tr><td>"+l(i,"form-control-static text-right")+"</td>";return a.eachSubject((function(a,n){var r=e.observedCount(t,i.pk,n);void 0===r&&(r="");var o=b({class:"form-control app-transect-subject-input number-input center-block","data-species":i.pk,"data-subject":n,value:r});s+="<td>"+o+"</td>"}),n.pk),s+="</tr>"}(s,i,t)}),t.pk),u+=function(e){var t=0;return a.eachSubject((function(){t++}),e.pk),'<tr><td><select class="form-control species-selector" data-group="'+e.pk+'"></select></td><td colspan="'+t+'"></td></tr>'}(t)})),u+="</table>",p.append(u),a.eachGroup((function(e){d.set_group(e).render($('.species-selector[data-group="'+e.pk+'"]'))}));p.append("</form>"),n.find("form").toggleClass("form-inline",a.pinpoint_observation).toggleClass("form-horizontal",!a.pinpoint_observation)}}};var g=class{constructor(e,t,i){this.map=e,this.options=i=c({output_selector:"[name=samples]",modal_selector:"#pinpoint_form",table_selector:"#observations",mapclick_create:!0,create_button_selector:"",enable_fix_location_checkbox:!1,default_fix_location_state:!0,warn_for_unsaved_changes:!0},i),this.modal=$(i.modal_selector),this.table=$(i.table_selector);try{var a=this.form_data=new o(t)}catch(e){return void this.table.html("<h1>Error in protocol: <em>"+e+"</em></h1>")}this.renderer=new _(this.form_data,i),this._=this.form_data._,this.markers={},this.editing_state=!1,this.tableRenderer=new h(a,i,this.table);var n=this;i.mapclick_create&&e.on("click",(function(e){if(!n.editing_state){var t=a.createPin(e.latlng);i.enable_fix_location_checkbox&&(t.fix_location=i.default_fix_location_state),n.addMapMarker(a.createMarker(t)),n.showEditor(t.name)}})),i.create_button_selector&&$(i.create_button_selector).on("click",(function(){var e=a.createPin();n.showEditor(e.name)}));var s=L.latLngBounds();e.geojson_layer&&s.extend(e.geojson_layer.getBounds()),a.eachPin((function(e){if(e.latlng){var t=n.addMapMarker(a.createMarker(e));s.extend(t.getLatLng())}}),this),s.isValid()&&e.fitBounds(s.pad(.2)),this.update(),this.initModal(),this.table.on("click","[data-target]",(function(){var t=""+$(this).parent().data("pin-name");switch($(this).data("target")){case"move-marker":var i=n.markers[t];alert(a._("click on map to choose new location")),n.editing_state=!0,e.once("click",(function(e){L.DomEvent.preventDefault(e),a.setLatLng(t,e.latlng),i.setLatLng(e.latlng),n.update(),n.editing_state=!1,n.dirty=!0}));break;case"delete":n.dirty=!0,n.removePin(t);break;default:n.showEditor(t)}})),n.dirty=!1,i.warn_for_unsaved_changes&&(window.onbeforeunload=function(){if(n.dirty)return!0},$(i.output_selector).parents("form").find('input[type="submit"]').on("click",(function(){window.onbeforeunload=null})))}initModal(){var e=this.modal,t=this.form_data,i=t._,a=this.renderer,n=this,s=t.protocol.pinpoint_observation;e.on("shown.bs.modal",(function(){$(this).find("input").first().focus()})),e.on("hidden.bs.modal",(function(){n.update()})),s||e.on("select2:close",".species-selector",(function(){var i=e.data("name"),s=+$(this).val();if(""!=s){var r=$(this).select2("data")[0];e.find(".select2-hidden-accessible").select2("destroy"),n.saveEditorData(!0),t.protocol.activateSpecies(s,r.original),a.modal(e,i),e.find('input[data-species="'+s+'"]').first().focus()}}));var r=function(){if(s){var t=function(t){var i=$(e).find(t).val();return""!=i&&null!=i&&null!=i};if(!t(".species-selector"))return void alert(i("you must select a species",!0));if(!t(".subject-selector"))return void alert(i("you must select a subject",!0))}n.saveEditorData(),e.modal("hide")};e.on("click","[data-save]",r),e.on("keypress",(function(e){13==e.which&&(r(),e.preventDefault())})),e.on("click","[data-dismiss]",(function(){var i=t.getPin($(e).data("name"));"delete_on_cancel"in i&&n.removePin(i.name,!0),n.update(),e.modal("hide")}))}showEditor(e){this.form_data.protocol.sortActiveSpecies(),this.renderer.modal(this.modal,e),this.modal.modal({backdrop:"static",keyboard:!1})}addMapMarker(e){var t=this;return e.addTo(this.map),e.on("click",(function(e){t.showEditor(e.target.feature.properties.name),L.DomEvent.stopPropagation(e)})),this.markers[e.feature.properties.name]=e,e}removePin(e,t){var i=this.form_data._;return!(!t&&!confirm(i("are you sure you want to delete this observation?",!0)))&&(this.markers[e]&&this.markers[e].removeFrom(this.map),this.form_data.removePin(e),this.update(),!0)}saveEditorData(e){e=!0===e;var t=this.modal.data("name"),i=this.form_data,a=i.getPin(t),n=this.modal;i.protocol.pinpoint_observation?i.updateCount(t,+$(".species-selector").val(),+$(".subject-selector").val(),n.find("input.number-input").val()):(a.not_counted&&(a.not_counted=!1),n.find("[data-sample-attr]").each((function(){var e=$(this);i.updateAttribute(t,+e.data("sample-attr"),e.val())})),n.find("input.number-input").each((function(){var e=$(this);i.updateCount(t,+e.data("species"),+e.data("subject"),e.val())}))),this.options.enable_fix_location_checkbox&&(a.fix_location=n.find("input[type=checkbox]").prop("checked")),e||(delete a.delete_on_cancel,this.dirty=!0)}update(){$(this.options.output_selector).val(this.form_data.serialize()),this.form_data.protocol.sortActiveSpecies(),this.tableRenderer.render(this.form_data.tableData())}},k=(i(13),{Protocol:r,PinpointController:g,Pinpoint:o,PinpointModal:_,PinpointTable:h,is_primary:n})},,,,,,,function(e,t,i){}]);
//# sourceMappingURL=fieldwork.js.map